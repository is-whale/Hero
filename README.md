# HLL Super Hero

#### 用户文件夹目录

-User		自定义文件位置

-Robot——Config		其中的.h文件是机器人配置文件

#### TODO:
- 比赛终局无视掉血的狂暴发射模式
- 监听任务
- pitch在自稳模式下的限位
- 摩擦轮还要多测试，之前有右侧摩擦轮掉线问题
- config.h  完成功能后将所有或者大部分配置项移植到config.h中。已导入，未全部实现
- 完善不同情况的蜂鸣器响应（错误，模式，状态等）
- 完善串口打印的错误码
- 完成带行号，时间戳的打印码
- **键鼠键位设计       加入一键掉头等模式**
- 超级电容数据
- UI                先不急
- 官步一阶低通滤波代替斜坡
- 板加磁屏蔽层
## 代码规范
变量名全部小写；
宏定义全部大写；
函数名首字母大写；

缩进等采用vscode配置的LLVM格式化模式；

## Hll 2022 Super Hero 工程日志

- [x] 模块检测任务
- [x] 串口 1 DMA 双缓冲接收
- [x] 遥控器任务完成
- [x] 增加机器人模式
- [x] 增加遥控器进一步的数据解析
- [x] 改进 printf 使用 Mutex 打印
- [x] 云台角度控制
- [ ] can 发送队列
- [x] 蜂鸣器任务
- [x] 云台发射电机速度初步设置
- [x] 底盘基本运动控制
- [x] 陀螺仪数据读取四元数解析输出三轴角度
- [x] 底盘完整的模式切换
- [x] 裁判系统数据读取解析
- [ ] 结构体等统一添加memset的初始化
- [ ] 卡尔曼滤波数据解析，以及遥控器和电机数据的低通滤波或斜坡函数（频率不一致，低频的数据在高频使用中会有阶跃和延迟问题）
- [x] 超级电容管理(finish,待测试)
- [x] 底盘完整的模式切换
- [x] 裁判系统数据读取解析
- [x] 功率控制（纯算法实现功率控制）
- [ ] 基于裁判系统的射速射频控制
- [ ] 超级电容使用逻辑
- [ ] 继续测试发射
- [ ] 专门配合英雄或者步兵的 QT 上位机界面
- [ ] pitch轴自稳定设计（原Yaw上电的初始模式具有保持绝对空间稳定的作用，即无输入状态的IMU云台模式）
## Problem

- [ ] 注意最好不要在任务中接收 CAN 的数据，经测试会卡死，但也不一定，只是我出现了这个问题

- [ ] 出现了莫名其妙的 undefined reference to Rc_Ctrl_t ，虽然后面不报了，但仍没找出 bug

- [x] CAN 在使用 HAL 库的时候，如果不接收 CAN 的数据，会出现任务卡死

  ```c++
  HAL_CAN_GetRxMessage(&hcan2, CAN_RX_FIFO0, can2_rx_header, can2_rxd_data_buffer);
  ```
  ** 该问题已解决，由于语法出错，在接收函数中传入了一个空地址导致该错误的发生`**

- [x] 注意不要在中断中随便打印数据，否则可能会造成死锁。

- [ ] 自稳模式下Pit限幅函数失效。

- [x] 目前跟随还有方向问题需要修改。详细记录如下

调试完成之后发现跟随模式下跟随的是屁股，原因是英雄Yaw是通过一对齿轮驱动，所以执行逻辑和步兵相反，包括Yaw轴角度闭环以及跟随PID输出。故Yaw电机电流发送取负可以正常响应调试，但是会出现跟屁股以及在屁股的中点震荡，并不是超调的震荡。将对应的chassis_follow_pid取反后模式正常。这部分需要修改。并且，两个值取反之后前后运动反向，暂时直接将chassis取反解决问题；

## Advanced

- 基于 Mutex 的 printf 打印，避免操作系统使用 printf 时出现的死锁以及任务优先级翻转等问题。

- 模仿 JavaScript 使用的 Console.print() 、Console.error()、Console.log() 提高程序的规范化（其实就是一个函数指针结构体的使用，看起来高级了点）。

- 使用板载陀螺仪，配合四元数进行解析。

- 待增加 Kalman Filter 进行滤波融合。

- 基于回调函数（函数指针）、链表和无线串口的在线 CMD。

- 专门配合于英雄或者步兵的基于 QT 的上位机界面。
- 图传UI界面设计
- 功率显示
- pitch轴机械角度显示
- 自稳云台
## note

- 裁判系统上电顺序不同，主板已启动但是其余电机暂时未启动，在这段时间内最好不要动摇杆，可能需要把状态写入到UI
- 自稳模式下的操作逻辑类似于三轴云台，有控制动作时正常响应，没有控制动作时保持空间绝对坐标系下的角度稳定，从而达到坦克火炮的垂稳效果；
- 自稳模式已初步完成，等待完善限位；



底盘解析进中断；(待上车测试然后删除解析任务)，另底盘解析要进中断  finish
移植功率解读以及数据利用；finish
官方步兵的任务数据初始化是在延时之后，获取稳定的陀螺仪数据；

上电的初始模式可以维持Yaw在绝对空间坐标系下的稳定。不随底盘而变化。切换到遥控器模式会消失。
